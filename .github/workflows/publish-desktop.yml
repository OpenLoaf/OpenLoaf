name: Publish Desktop

on:
  push:
    tags:
      - 'electron-v*'
  workflow_dispatch:
    inputs:
      channel:
        description: 'Release channel'
        required: false
        default: 'stable'
        type: choice
        options:
          - stable
          - beta
      build_mac:
        description: 'Build macOS'
        required: false
        default: true
        type: boolean
      build_windows:
        description: 'Build Windows'
        required: false
        default: true
        type: boolean
      build_linux:
        description: 'Build Linux'
        required: false
        default: true
        type: boolean

concurrency:
  group: desktop-publish
  cancel-in-progress: false

env:
  ELECTRON_CACHE: .cache/electron
  ELECTRON_BUILDER_CACHE: .cache/electron-builder

jobs:
  build-prerequisites:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Use HTTPS for git dependencies
        run: git config --global url."https://github.com/".insteadOf "git@github.com:"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        run: pnpm run db:generate

      - name: Validate tag version matches package.json
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/electron-v}"
          PKG_VERSION=$(node -p "require('./apps/desktop/package.json').version")
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "::error::Tag version ($TAG_VERSION) does not match package.json version ($PKG_VERSION)"
            exit 1
          fi

      - name: Build workspace packages
        run: pnpm --filter @openloaf/widget-sdk run build

      - name: Build server
        run: pnpm --filter server run build:prod

      - name: Build web
        run: pnpm --filter web run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openloaf-build
          path: |
            apps/server/dist/server.mjs
            apps/server/dist/seed.db
            apps/web/out

  build-mac-arm64:
    needs: build-prerequisites
    if: github.event_name == 'push' || inputs.build_mac
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-${{ runner.arch }}-

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            .cache/electron
            .cache/electron-builder
          key: electron-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            electron-${{ runner.os }}-${{ runner.arch }}-

      - name: Use HTTPS for git dependencies
        run: git config --global url."https://github.com/".insteadOf "git@github.com:"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --filter desktop...

      - name: Generate Prisma client
        run: pnpm run db:generate

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: openloaf-build
          path: apps

      - name: Build and package desktop (macOS ARM64)
        working-directory: apps/desktop
        env:
          CSC_LINK: ${{ secrets.MAC_CER_BASE64 }}
          CSC_KEY_PASSWORD: ${{ secrets.MAC_CER_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: pnpm run dist:mac:ci

      - name: Upload macOS ARM64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openloaf-desktop-macos-arm64
          path: |
            apps/desktop/dist/*.dmg
            apps/desktop/dist/*.dmg.blockmap
            apps/desktop/dist/*-mac.zip
            apps/desktop/dist/*-mac.zip.blockmap
            apps/desktop/dist/latest-mac.yml

  build-mac-x64:
    needs: build-prerequisites
    if: github.event_name == 'push' || inputs.build_mac
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js (x64 via Rosetta 2)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          architecture: x64

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-${{ runner.arch }}-

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            .cache/electron
            .cache/electron-builder
          key: electron-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            electron-${{ runner.os }}-${{ runner.arch }}-

      - name: Use HTTPS for git dependencies
        run: git config --global url."https://github.com/".insteadOf "git@github.com:"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --filter desktop...

      - name: Generate Prisma client
        run: pnpm run db:generate

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: openloaf-build
          path: apps

      - name: Build and package desktop (macOS x64)
        working-directory: apps/desktop
        env:
          CSC_LINK: ${{ secrets.MAC_CER_BASE64 }}
          CSC_KEY_PASSWORD: ${{ secrets.MAC_CER_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: pnpm run dist:mac:ci

      - name: Upload macOS x64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openloaf-desktop-macos-x64
          path: |
            apps/desktop/dist/*.dmg
            apps/desktop/dist/*.dmg.blockmap
            apps/desktop/dist/*-mac.zip
            apps/desktop/dist/*-mac.zip.blockmap
            apps/desktop/dist/latest-mac.yml

  build-windows:
    needs: build-prerequisites
    if: github.event_name == 'push' || inputs.build_windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-${{ runner.arch }}-

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            .cache/electron
            .cache/electron-builder
          key: electron-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            electron-${{ runner.os }}-${{ runner.arch }}-

      - name: Use HTTPS for git dependencies
        run: git config --global url."https://github.com/".insteadOf "git@github.com:"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --filter desktop...

      - name: Generate Prisma client
        run: pnpm run db:generate

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: openloaf-build
          path: apps

      - name: Build and package desktop (Windows)
        working-directory: apps/desktop
        run: pnpm run dist:win:ci

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openloaf-desktop-windows
          path: |
            apps/desktop/dist/*.exe
            apps/desktop/dist/*.exe.blockmap
            apps/desktop/dist/latest.yml

  build-linux:
    needs: build-prerequisites
    if: github.event_name == 'push' || inputs.build_linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-${{ runner.arch }}-

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            .cache/electron
            .cache/electron-builder
          key: electron-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            electron-${{ runner.os }}-${{ runner.arch }}-

      - name: Use HTTPS for git dependencies
        run: git config --global url."https://github.com/".insteadOf "git@github.com:"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --filter desktop...

      - name: Generate Prisma client
        run: pnpm run db:generate

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: openloaf-build
          path: apps

      - name: Build and package desktop (Linux)
        working-directory: apps/desktop
        run: pnpm run dist:linux:ci

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openloaf-desktop-linux
          path: |
            apps/desktop/dist/*.AppImage
            apps/desktop/dist/latest-linux.yml

  publish-to-r2:
    needs: [build-mac-arm64, build-mac-x64, build-windows, build-linux]
    if: >-
      always() &&
      !contains(needs.*.result, 'failure') &&
      contains(needs.*.result, 'success')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install publish dependencies
        run: |
          cd scripts/shared
          npm init -y > /dev/null 2>&1
          npm install @aws-sdk/client-s3

      - name: Download all platform artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: openloaf-desktop-*
          path: apps/desktop/dist
          merge-multiple: true

      - name: List artifacts
        run: ls -la apps/desktop/dist/

      - name: Publish to R2
        env:
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        run: node apps/desktop/scripts/publish-update.mjs --skip-build

  create-release:
    needs: publish-to-r2
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/electron-v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Read changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CHANGELOG_FILE="apps/desktop/changelogs/${VERSION}/en.md"
          if [ -f "$CHANGELOG_FILE" ]; then
            # Strip frontmatter (between --- markers)
            BODY=$(sed '/^---$/,/^---$/d' "$CHANGELOG_FILE")
          else
            BODY="Release v${VERSION}"
          fi
          # Write to file for gh release create --notes-file
          echo "$BODY" > /tmp/release-notes.md

      - name: Download all platform artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: openloaf-desktop-*
          path: dist
          merge-multiple: true

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Collect installable files (exclude yml and blockmap)
          FILES=$(find dist -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.AppImage" -o -name "*-mac.zip" \))
          gh release create "electron-v${VERSION}" \
            --title "OpenLoaf Desktop v${VERSION}" \
            --notes-file /tmp/release-notes.md \
            $FILES

  version-bump:
    needs: create-release
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Bump patch version
        run: |
          cd apps/desktop
          npm version patch --no-git-tag-version

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          NEW_VERSION=$(node -p "require('./apps/desktop/package.json').version")
          git add apps/desktop/package.json
          git commit -m "chore(desktop): bump version to ${NEW_VERSION} [skip ci]"
          git pull --rebase origin main
          git push origin main
