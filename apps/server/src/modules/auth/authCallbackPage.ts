/**
 * Copyright (c) OpenLoaf. All rights reserved.
 *
 * This source code is licensed under the AGPLv3 license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * Project: OpenLoaf
 * Repository: https://github.com/OpenLoaf/OpenLoaf
 */
type AuthCallbackPageOptions = {
  message: string;
  returnUrl?: string;
};

// 中文注释：默认回到桌面端协议地址。
const DEFAULT_RETURN_URL = "openloaf://open";

/** Escape HTML special characters to prevent injection. */
function escapeHtml(value: string): string {
  return value.replace(/[&<>"']/g, (char) => {
    switch (char) {
      case "&":
        return "&amp;";
      case "<":
        return "&lt;";
      case ">":
        return "&gt;";
      case '"':
        return "&quot;";
      case "'":
        return "&#39;";
      default:
        return char;
    }
  });
}

/** Render the auth callback page HTML string. */
export function renderAuthCallbackPage(options: AuthCallbackPageOptions): string {
  const rawMessage = options.message ?? "";
  const safeMessage = escapeHtml(rawMessage);
  const returnUrl = (options.returnUrl ?? DEFAULT_RETURN_URL).trim() || DEFAULT_RETURN_URL;
  const safeReturnUrl = escapeHtml(returnUrl);

  return `<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <title>OpenLoaf 登录</title>
    <style>
      :root {
        --bg: #f6f8fc;
        --text: #202124;
        --text2: #5f6368;
        --btn-bg: #e8f0fe;
        --btn-fg: #1a73e8;
        --btn-hover: #d2e3fc;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #0f1115;
          --text: #f1f5f9;
          --text2: #94a3b8;
          --btn-bg: rgba(56,139,253,0.15);
          --btn-fg: #7dd3fc;
          --btn-hover: rgba(56,139,253,0.25);
        }
      }
      * { box-sizing: border-box; margin: 0; }
      body {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
        background: var(--bg);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        color: var(--text);
        text-align: center;
      }
      .logo { width: 72px; height: 72px; margin: 0 auto 16px; border-radius: 16px; }
      @media (prefers-color-scheme: dark) {
        .logo { background: #1e1e24; }
      }
      h1 { font-size: 28px; font-weight: 600; margin-bottom: 10px; }
      p { font-size: 15px; color: var(--text2); line-height: 1.5; }
      .btn {
        display: inline-block;
        margin-top: 20px;
        padding: 11px 28px;
        border-radius: 999px;
        border: none;
        background: var(--btn-bg);
        color: var(--btn-fg);
        font-size: 15px;
        font-weight: 500;
        text-decoration: none;
        transition: background-color 150ms;
      }
      .btn:hover { background: var(--btn-hover); }

    </style>
  </head>
  <body>
    <main>
      <svg class="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024"><defs><style>.l1{fill:#e9be94}.l2{fill:#b16d2b}.l3{fill:#fdf3de}.l4{fill:#d7a84f}.l5{fill:#c17f2f}.l6{fill:#76482b}</style></defs><rect class="l3" x="100" y="100" width="824" height="824" rx="185.4" ry="185.4"/><path class="l1" d="M685.27,846.69l-18.23,1.73c-98.62,2.76-207.46,3.93-311.81-2.53-16.07-.99-36.01-3.6-52.53-5.77-33.59-4.41-169.98-26.87-62.27-56.09,4.82-1.31,9.92-1.97,14.83-2.75,22.51,43.67,78.25,51.4,107.03,9.82,3.27-4.73,4.67-14.27,10.51-15.36l282.92-.07c19.33,53.56,91.29,57.19,116.01,5.61,20.08,1.57,83.1,20.93,37.54,40.2-30.33,12.83-62.35,14.47-94.93,20.89"/><path class="l6" d="M255.27,781.3c-7.79-15.12-4.37-8.15-15.69-18.5-22.08-20.18-22.19-37.51-26.62-65.75-7.48-47.69-11.51-97.3-17.16-145.33s-32.44-128.86,32.53-147.07c11.78-3.3,55.26-3.21,68.59-1.75,7.43.81,12.27,5.15,19.42,5.53,2.71-15.75-14.3-18.01-24.66-26.15-54.17-42.53-33.49-113.26,18.55-147,37.72-24.45,133.12-47.51,176.53-38.28,9.39,2,26.06,10.61,33.99,10.24,1.1-.05,1.12-3.05,2.49-3.57,50.56-18.97,141.64,3.25,187.99,29.77,54.53,31.2,77.78,100.8,25.37,146.41-4.91,4.28-24.27,14.38-25.04,15.64-2.04,3.35-.54,9.06-.89,12.94,6.73-1.06,12.54-4.79,19.41-5.54,19.11-2.08,60.49-1.93,77.22,6.08,53.26,25.51,28.67,90.49,23.87,135.33-6.02,56.33-7.57,125.69-19.22,180.19-3.29,15.41-10.68,26.46-22.68,36.46-3.82,3.19-12.71,6.8-14.67,9.36-2.61,3.41-1.71,8.58-2.87,10.99-24.72,51.58-96.69,47.95-116.01-5.61l-282.92.07c-5.84,1.1-7.24,10.64-10.51,15.36-28.79,41.58-84.53,33.85-107.03-9.82Z"/><path class="l5" d="M321.91,556.1c-8.09,4.69-39.03,16.75-40.73,24-1.13,4.8-.25,12.23,6.39,11.16,35.41-6.15,71.67-15.6,107.45-18.73,8.53-.75,8.75.3,18.62-1.57,13.46-2.55,9.13,4.91,15.1,6.9,4.11,1.37,16.9,3.16,22.04,3.86,45.64,6.21,97.85,8.38,143.36-2.43,8.69-2.06,19.55-8.64,28.56-8.59,17.5.11,38.78,8.06,56.87,8.07l63.3,13.92,4.42-6.48c.73-3.14-2.4-4.45-3.33-6.12-.6-1.08-.27-3.16-1.72-4.67-6.36-6.61-32.93-17.26-42.63-19.4.69-16.89-1.23-34.86-.08-51.61.88-12.89,3.87-31.72,11.42-43.07,2.74-4.12,11.17-12,15.43-14.15,9.72-4.92,43.99-5.14,55.58-3.74,8.66,1.05,23.06,9.25,27.58,16.8,2.09,3.51,6.24,18.05,6.62,22.01,1.09,11.23-2.45,34.54-3.71,47.06-6.25,61.85-15.41,123.73-22.2,185.52-3.17-1.9-1.96-6.88-1.65-9.91.2-1.96,4.76-15.9-1.11-14.1-9.66,16.43-26.65,29.58-46.33,31.36l-453.57.1c-14.73-.4-29.69-9.09-39.81-19.37-4.45-4.52-5.85-13.42-12.88-12.07-10.32-66.9-19.67-141.21-25.92-208.58,2.84-16.01,12.88-33.4,29.96-37.5,10.2-2.45,36-2.33,46.84-1.24,29.86,2.99,36.56,28.84,38.06,54.34,1.08,18.33.52,40.24-1.94,58.23Z"/><path class="l2" d="M234.91,690.85c7.04-1.35,8.44,7.55,12.88,12.07,10.12,10.28,25.08,18.97,39.81,19.37l453.57-.1c19.68-1.78,36.67-14.93,46.33-31.36,5.87-1.8,1.32,12.15,1.11,14.1-.32,3.03-1.52,8.01,1.65,9.91-11.72,51.18-51.93,32.21-91.54,38.85-131.99-5.02-268.56,6.37-400.02-.01-26.91-1.31-51.66-2.59-59.24-33.22-2.11-8.51-3.14-20.48-4.54-29.62Z"/><path class="l4" d="M737.72,343.14c-4.02,6.47-19.73,23.97-26.43,28.09s-17.22,4.71-20.5,12.78c-6.33,54.72-5.71,110-9.75,164.72-25.74-5.53-50.81-13.07-77.05-16.39-59.38-7.52-132.86-6.83-192.03,1.88-22.72,3.34-45.04,9.47-66.97,16.03l-2.72-4.29-5.94-160.2c-1.98-8.85-14.19-10.1-20.94-14.19-45.77-27.75-42.74-78.43-3.7-110.84,33.55-27.85,121.82-49.05,164.6-44.06,12.09,1.41,26.74,10.69,37.2,11.05,13.52.46,27.73-9.06,41.22-10.77,36.24-4.61,125.64,19.3,155.8,41.21,24.04,17.47,44.89,56.57,27.22,84.98Z"/><path class="l4" d="M743.98,580.1c.93,1.66,4.06,2.98,3.33,6.12l-4.42,6.48-63.3-13.92c-18.1,0-39.37-7.96-56.87-8.07-9.01-.05-19.87,6.52-28.56,8.59-45.51,10.81-97.72,8.63-143.36,2.43-5.14-.7-17.93-2.49-22.04-3.86-5.98-1.99-1.64-9.45-15.1-6.9-9.87,1.87-10.09.82-18.62,1.57-35.78,3.14-72.04,12.58-107.45,18.73-6.64,1.07-7.52-6.37-6.39-11.16,4.33-3.35,10.85-1.5,14.81-2.75,127.12-40.38,300.75-39.96,428.02-4.11,6.76,1.9,13.46,4.28,19.96,6.86Z"/><path class="l4" d="M747.68,773.91c-8.34,33.56-57.71,32.26-66.64,0h66.64Z"/><path class="l4" d="M344.13,773.91c.5,2.67.02,3.38-1.3,5.41-9.72,14.97-24.98,22.36-43.18,17.71-5.44-1.39-19.36-11.05-19.68-16.67-.09-1.56,3.21-6.46,4-6.46h60.16Z"/><path class="l5" d="M669.92,290.31l-26.99,40.45-13.6,14.25,22.08,35.73-32.33-23.99c-11.15,12.09-22.63,26.5-34.28,37.86-10.81,10.54-26.36,24.54-38.03,34.07-4.27,3.49-10.04,8.55-15.67,9.27-1.28-1.25,11.22-17.07,13-19.32,19.79-24.94,41.6-50.87,64.87-72.18l-22.31-36.8,32.1,24.81c12.72-9.39,22.77-21.81,34.47-32.2,1.82-1.61,15.42-13.23,16.68-11.96Z"/><path class="l5" d="M420.97,257.12c-15.06,32.52-43.4,58.5-72.23,79.3,15.04-33.02,43.74-57.76,72.23-79.3Z"/><path class="l5" d="M527.38,391.82c-1.23,1.26-17.3-11.27-19.37-12.97-4.65-3.82-19.74-21.06-23.99-20.37-1.89.3-20.3,26.23-24.84,29l10.82,20.95c-2.04,2.12-13.32-10.01-16.14-10.79-9.36-2.6-24.21,22.56-31.53,28.31l31.97,45.21c-17.24-7.55-29.26-22.49-42.85-34.9l-33.95,24.81,25.6-33.51-14.53-28.33,22.88,16.47c3.69-4.88,26.07-25.69,26.9-28.85.49-1.86.05-2.63-.67-4.21-1.52-3.32-18.06-19.01-22.52-25.64-3.92-5.82-9.48-13.59-9.92-20.55l43.36,38.7,26.71-27.11c3.1-5.46-15.62-23.44-12.7-26.35,8.58.19,16.02,15.53,23.04,14.85,4.95-.48,22.96-22.81,31.59-24.05l-23.03,33.86c4.68,3.83,35.68,42.92,33.19,45.46Z"/><path class="l5" d="M644.01,426.91l-24.96,36.93c-14.53,15.4-29.87,29.64-48.17,40.55-.15-4.13,2.74-8.36,4.94-11.66,11.9-17.78,34.13-41.03,50.67-54.69,2.08-1.72,16.02-12.61,17.52-11.12Z"/></svg>
      <h1>${safeMessage}</h1>
      <p>可以关闭此页面，或点击下方按钮返回应用。</p>
      <a class="btn" href="${safeReturnUrl}" data-open-app>返回 OpenLoaf</a>

    </main>
    <script>
      (() => {
        const b = document.querySelector("[data-open-app]");
        if (!b) return;
        b.addEventListener("click", () => {
          setTimeout(() => { window.close(); }, 120);
        });
      })();
    </script>
  </body>
</html>`;
}
