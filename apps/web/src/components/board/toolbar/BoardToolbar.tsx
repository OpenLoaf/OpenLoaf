"use client";

import { memo, useCallback, useEffect, useId, useMemo, useRef, useState } from "react";
import type { ChangeEvent, CSSProperties, ReactElement } from "react";
import { cn } from "@udecode/cn";

import type { CanvasEngine } from "../engine/CanvasEngine";
import type { CanvasInsertRequest, CanvasSnapshot } from "../engine/types";
import { HoverPanel, IconBtn, PanelItem } from "../ui/ToolbarParts";
import { isBoardUiTarget } from "../utils/dom";

export interface BoardToolbarProps {
  /** Canvas engine instance. */
  engine: CanvasEngine;
  /** Snapshot used for tool state. */
  snapshot: CanvasSnapshot;
}

type ToolMode = "select" | "hand" | "pen" | "highlighter" | "eraser";

type IconProps = {
  size?: number;
  className?: string;
};

const PEN_SIZES = [3, 6, 10, 14];
const PEN_COLORS = ["#111827", "#1d4ed8", "#f59e0b", "#ef4444", "#16a34a"];

type InsertItem = {
  id: string;
  title: string;
  description: string;
  icon: (props: IconProps) => ReactElement;
  /** Node type inserted by this item. */
  nodeType?: string;
  /** Optional custom props for the inserted node. */
  props?: Record<string, unknown>;
  size: [number, number];
  opensPicker?: boolean;
};

type ShapeItem = {
  id: string;
  title: string;
  description: string;
  icon: (props: IconProps) => ReactElement;
  size: [number, number];
};

/** Label mapping for toolbar tooltips. */
const TOOL_LABELS = {
  select: "选择",
  hand: "拖拽",
  pen: "画笔",
  highlighter: "荧光笔",
  eraser: "橡皮",
  shape: "形状",
  note: "便签",
  image: "图片",
  calendar: "日历",
  sticker: "贴纸",
  video: "视频",
} as const;

/** Shortcut mapping for tooltips. */
const TOOL_SHORTCUTS = {
  select: "A",
  hand: "W",
  pen: "P",
  highlighter: "K",
  eraser: "E",
} as const;

/** Label mapping for insert tool tooltips. */
const INSERT_TOOL_LABELS: Record<string, string> = {
  note: TOOL_LABELS.note,
  image: TOOL_LABELS.image,
  calendar: TOOL_LABELS.calendar,
  sticker: TOOL_LABELS.sticker,
  video: TOOL_LABELS.video,
};

/** Label mapping for shape tool tooltips. */
const SHAPE_TOOL_LABELS: Record<string, string> = {
  "shape-rect": "矩形",
  "shape-circle": "椭圆",
  "shape-triangle": "三角形",
  "shape-diamond": "菱形",
};

/** Build a tooltip label with optional shortcut suffix. */
function buildToolTitle(label: string, shortcut?: string): string {
  return shortcut ? `${label} (${shortcut})` : label;
}

const BRUSH_SVG_SRC = "/board/brush.svg";
const CALENDAR_SVG_SRC = "/board/calendar-svgrepo-com.svg";
const HIGHLIGHTER_SVG_SRC = "/board/highlighter.svg";
const ERASER_SVG_SRC = "/board/eraser.svg";
const SELECT_SVG_SRC = "/board/select-cursor-svgrepo-com.svg";
const DRAG_SVG_SRC = "/board/drag-svgrepo-com.svg";
const NOTE_SVG_SRC = "/board/notes-note-svgrepo-com.svg";
const PICTURE_SVG_SRC = "/board/picture-photo-svgrepo-com.svg";
const VIDEO_SVG_SRC = "/board/video-file-svgrepo-com.svg";

const prefixSvgIds = (svg: string, prefix: string) => {
  const safePrefix = prefix.replace(/:/g, "");
  return svg
    .replace(/id="([^"]+)"/g, `id="${safePrefix}-$1"`)
    .replace(/url\\(#([^)]+)\\)/g, `url(#${safePrefix}-$1)`)
    .replace(/xlink:href="#([^"]+)"/g, `xlink:href="#${safePrefix}-$1"`)
    .replace(/href="#([^"]+)"/g, `href="#${safePrefix}-$1"`);
};

const normalizeSvgRootSize = (svg: string) => {
  const withWidth = svg.replace(/<svg([^>]*?)width="[^"]*"/, '<svg$1width="100%"');
  return withWidth.replace(/<svg([^>]*?)height="[^"]*"/, '<svg$1height="100%"');
};

/** Cache for loaded public svg markup. */
const svgCache = new Map<string, string>();

function InlineSvg(props: {
  svg: string;
  className?: string;
  style?: CSSProperties;
}) {
  const { svg, className, style } = props;
  const id = useId();
  const html = useMemo(() => {
    const withIds = prefixSvgIds(svg, id);
    return normalizeSvgRootSize(withIds);
  }, [id, svg]);
  return (
    <span
      className={cn("inline-flex", className)}
      style={style}
      aria-hidden="true"
      dangerouslySetInnerHTML={{ __html: html }}
    />
  );
}

/** Load svg markup from public assets with a small client cache. */
function usePublicSvg(src: string) {
  const [svg, setSvg] = useState<string | null>(() => svgCache.get(src) ?? null);

  useEffect(() => {
    if (svgCache.has(src)) {
      setSvg(svgCache.get(src) ?? null);
      return;
    }
    let active = true;
    // 逻辑：首次加载时从 public 拉取 svg 文本并缓存，避免重复请求。
    fetch(src)
      .then((response) => (response.ok ? response.text() : ""))
      .then((text) => {
        if (!active || !text) return;
        svgCache.set(src, text);
        setSvg(text);
      })
      .catch(() => {
        // 逻辑：加载失败时保持静默，避免影响工具栏交互。
      });
    return () => {
      active = false;
    };
  }, [src]);

  return svg;
}

/** Render inline svg loaded from public path. */
function InlineSvgFile({
  src,
  className,
  style,
}: {
  src: string;
  className?: string;
  style?: CSSProperties;
}) {
  const svg = usePublicSvg(src);
  if (!svg) {
    return (
      <span
        className={cn("inline-flex", className)}
        style={style}
        aria-hidden="true"
      />
    );
  }
  return <InlineSvg svg={svg} className={className} style={style} />;
}

function SelectIcon({ size = 20, className }: IconProps) {
  return (
    <InlineSvgFile
      src={SELECT_SVG_SRC}
      className={cn("[&>svg]:fill-current", className)}
      style={{ width: size, height: size, userSelect: "none", flexShrink: 0 }}
    />
  );
}

function HandIcon({ size = 20, className }: IconProps) {
  return (
    <InlineSvgFile
      src={DRAG_SVG_SRC}
      className={cn("[&>svg]:fill-current", className)}
      style={{ width: size, height: size, userSelect: "none", flexShrink: 0 }}
    />
  );
}

/** Render the calendar icon with shared sizing props. */
function CalendarIcon(props: IconProps) {
  const { size = 20, className } = props;
  return (
    <InlineSvgFile
      src={CALENDAR_SVG_SRC}
      className={className}
      style={{ width: size, height: size, userSelect: "none", flexShrink: 0 }}
    />
  );
}

function ShapeIcon({ size = 20, className }: IconProps) {
  return (
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      width={size}
      height={size}
      fill="none"
      style={{ userSelect: "none", flexShrink: 0 }}
      className={className}
    >
      <path
        fill="currentColor"
        fillRule="evenodd"
        d="M12 3.25a.75.75 0 0 1 .651.378l3.556 6.222a.75.75 0 0 1-.651 1.122H8.444a.75.75 0 0 1-.65-1.122l3.555-6.222A.75.75 0 0 1 12 3.25M9.737 9.472h4.526L12 5.512zM7.11 14.528a2.361 2.361 0 1 0 0 4.722 2.361 2.361 0 0 0 0-4.722m-3.861 2.36a3.861 3.861 0 1 1 7.722 0 3.861 3.861 0 0 1-7.722 0m9.778-3.11a.75.75 0 0 1 .75-.75H20a.75.75 0 0 1 .75.75V20a.75.75 0 0 1-.75.75h-6.222a.75.75 0 0 1-.75-.75zm1.5.75v4.722h4.722v-4.722z"
        clipRule="evenodd"
      />
    </svg>
  );
}

function ImageIcon({ size = 20, className }: IconProps) {
  return (
    <InlineSvgFile
      src={PICTURE_SVG_SRC}
      className={className}
      style={{ width: size, height: size, userSelect: "none", flexShrink: 0 }}
    />
  );
}

function PageIcon({ size = 20, className }: IconProps) {
  return (
    <InlineSvgFile
      src={NOTE_SVG_SRC}
      className={className}
      style={{ width: size, height: size, userSelect: "none", flexShrink: 0 }}
    />
  );
}

function MoviePanelIcon({ size = 20, className }: IconProps) {
  return (
    <InlineSvgFile
      src={VIDEO_SVG_SRC}
      className={className}
      style={{ width: size, height: size, userSelect: "none", flexShrink: 0 }}
    />
  );
}

function NoteShadowDuotoneIcon({ size = 20, className }: IconProps) {
  return (
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      width={size}
      height={size}
      fill="none"
      style={{ userSelect: "none", flexShrink: 0 }}
      className={className}
    >
      <path
        fill="#7A7A7A"
        fillRule="evenodd"
        d="M3.25 5A2.75 2.75 0 0 1 6 2.25h9A2.75 2.75 0 0 1 17.75 5v10.857a2.75 2.75 0 0 1-2.75 2.75H6a2.75 2.75 0 0 1-2.75-2.75zM6 3.75c-.69 0-1.25.56-1.25 1.25v10.857c0 .69.56 1.25 1.25 1.25h9c.69 0 1.25-.56 1.25-1.25V5c0-.69-.56-1.25-1.25-1.25z"
        clipRule="evenodd"
      />
      <path
        fill="#B3B3B3"
        d="M6.25 18.607H15a2.75 2.75 0 0 0 2.75-2.75V5.25H18A2.75 2.75 0 0 1 20.75 8v10.857a2.75 2.75 0 0 1-2.75 2.75H9a2.75 2.75 0 0 1-2.75-2.75z"
      />
    </svg>
  );
}

function ScribbledSquareIcon({ size = 20, className }: IconProps) {
  return (
    <svg
      width={size}
      height={size}
      viewBox="0 0 20 20"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      className={className}
    >
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2.45993 3.83639C2.64271 3.81446 2.80866 3.94487 2.83059 4.12765C2.92285 4.89681 3.01537 5.61006 3.10321 6.28727C3.55933 9.80379 3.88941 12.3486 3.40424 16.7043C3.38386 16.8872 3.21901 17.019 3.03605 16.9986C2.85309 16.9783 2.72129 16.8134 2.74167 16.6304C3.21749 12.3587 2.89776 9.89136 2.44329 6.38415C2.3552 5.70441 2.26206 4.98561 2.16867 4.20705C2.14674 4.02427 2.27714 3.85832 2.45993 3.83639Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M14.6788 16.6731C13.5378 16.6615 12.1261 16.6616 11.0279 16.7078C9.45128 16.7741 7.43455 16.9812 5.80651 17.1726C4.99366 17.2682 4.27987 17.3596 3.76935 17.4271C3.51411 17.4609 3.30974 17.4887 3.16929 17.508L3.00817 17.5303L2.95355 17.538L2.90588 17.2081L2.85912 16.878L2.91585 16.8701L3.07845 16.8475C3.21994 16.8281 3.42545 16.8001 3.68194 16.7662C4.19488 16.6984 4.91194 16.6066 5.72866 16.5105C7.35976 16.3187 9.39704 16.1091 10.9999 16.0417C12.1163 15.9947 13.5424 15.9948 14.6856 16.0065C15.258 16.0123 15.761 16.0211 16.1209 16.0284C16.3009 16.032 16.4451 16.0353 16.5445 16.0377L16.6586 16.0405L16.6978 16.0415L16.6895 16.3747L16.6805 16.708L16.6416 16.7069L16.5285 16.7042C16.4299 16.7018 16.2865 16.6985 16.1074 16.6949C15.7492 16.6876 15.2485 16.6789 14.6788 16.6731ZM17.0228 16.3837C17.0178 16.5677 16.8646 16.7129 16.6805 16.708L16.6895 16.3747L16.6978 16.0415C16.8819 16.0465 17.0277 16.1997 17.0228 16.3837ZM2.57586 17.2549C2.54999 17.0727 2.67685 16.9039 2.85912 16.878L2.90588 17.2081L2.95355 17.538C2.77128 17.5639 2.60173 17.4372 2.57586 17.2549Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M16.2785 3.00004C16.4626 2.99705 16.6142 3.14384 16.6172 3.32791L16.2839 3.33333L15.9506 3.33875C15.9476 3.15468 16.0944 3.00304 16.2785 3.00004ZM15.8785 17.5L15.5461 17.4759L15.5604 17.2746C15.5695 17.1442 15.5827 16.9546 15.5988 16.7179C15.631 16.2445 15.6746 15.5827 15.7206 14.8294C15.8126 13.3217 15.9136 11.4516 15.9507 9.99154C15.9836 8.69575 15.9836 7.03343 15.9754 5.69274C15.9712 5.02289 15.9651 4.43425 15.9599 4.01309C15.9573 3.80252 15.955 3.63385 15.9533 3.51786L15.9506 3.33875L16.2839 3.33333L16.6172 3.32791L16.6199 3.50823C16.6216 3.62466 16.6239 3.79382 16.6265 4.00493C16.6317 4.42711 16.6379 5.01714 16.642 5.68864C16.6503 7.03063 16.6503 8.70165 16.6171 10.0085C16.5797 11.4809 16.4781 13.3608 16.386 14.87C16.3399 15.6251 16.2962 16.2885 16.2639 16.7631C16.2478 17.0004 16.2346 17.1905 16.2254 17.3214L16.211 17.5232L15.8785 17.5ZM15.8785 17.5L15.5461 17.4759C15.5327 17.6595 15.6708 17.8192 15.8544 17.8325C16.038 17.8458 16.1977 17.7077 16.211 17.5241L15.8785 17.5Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M17.8222 4.25378L17.8204 4.26045L17.8149 4.2812L17.7936 4.36248C17.7751 4.43352 17.7485 4.53713 17.7161 4.66674C17.6512 4.92604 17.5634 5.28896 17.4713 5.70299C17.2862 6.53525 17.0878 7.55848 17.0216 8.36138C16.9302 9.47192 16.9847 10.3393 17.0561 11.223C17.0633 11.3116 17.0706 11.4004 17.078 11.4898C17.1443 12.2918 17.2137 13.1322 17.1847 14.1766C17.1687 14.7528 17.1279 15.4868 17.0913 16.0741C17.073 16.3683 17.0556 16.6267 17.0429 16.8116C17.0365 16.9041 17.0312 16.9782 17.0276 17.0292L17.0219 17.1081L16.6894 17.084L16.357 17.0596L16.3626 16.9817C16.3662 16.9312 16.3714 16.8576 16.3778 16.7657C16.3905 16.5819 16.4077 16.325 16.4259 16.0326C16.4624 15.4467 16.5027 14.7223 16.5183 14.1581C16.5462 13.1522 16.4798 12.3467 16.4135 11.5437C16.4062 11.4547 16.3988 11.3658 16.3916 11.2767C16.3193 10.3821 16.2613 9.47185 16.3572 8.30666C16.4273 7.45607 16.6342 6.39597 16.8205 5.55827C16.9141 5.13732 17.0034 4.7686 17.0693 4.50502C17.1023 4.37318 17.1294 4.26753 17.1484 4.19467L17.1704 4.11077L17.1762 4.08879L17.1781 4.08154C17.2259 3.90374 17.4089 3.79769 17.5867 3.84542C17.7645 3.89315 17.8699 4.07598 17.8222 4.25378ZM16.6894 17.084L16.357 17.0596C16.3435 17.2432 16.4814 17.403 16.665 17.4165C16.8486 17.4299 17.0084 17.2917 17.0219 17.1081L16.6894 17.084Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2.17283 3.02528C2.20726 2.84434 2.38177 2.72526 2.5626 2.75931L2.50025 3.08692L2.43789 3.41454C2.25707 3.38049 2.13839 3.20622 2.17283 3.02528ZM16.7595 4.58093L16.7545 4.91426L16.7174 4.91377L16.6111 4.91221C16.5186 4.9108 16.3842 4.9086 16.2166 4.90547C15.8815 4.89921 15.4131 4.88922 14.8802 4.87428C13.8159 4.84446 12.4887 4.79477 11.451 4.71525C9.67135 4.57888 7.41581 4.25301 5.61119 3.96257C4.70758 3.81715 3.91464 3.68021 3.34754 3.57961C3.06396 3.52931 2.83678 3.48809 2.68039 3.45942C2.60219 3.44508 2.54168 3.43388 2.50067 3.42626L2.43789 3.41454C2.43784 3.41453 2.43789 3.41454 2.50025 3.08692L2.5626 2.75931L2.62388 2.77075C2.66438 2.77828 2.72434 2.78937 2.80196 2.80361C2.95722 2.83207 3.18314 2.87307 3.46534 2.92312C4.0298 3.02325 4.81916 3.15957 5.7185 3.30431C7.51977 3.59421 9.75269 3.91632 11.5034 4.05047C12.5242 4.1287 13.8381 4.17805 14.9003 4.20782C15.4307 4.22268 15.8969 4.23263 16.2305 4.23886C16.3973 4.24197 16.5309 4.24416 16.6228 4.24556L16.7281 4.24711L16.7638 4.24758L16.7595 4.58093ZM16.7595 4.58093L16.7545 4.91426C16.9386 4.91657 17.09 4.76919 17.0927 4.5851C17.0954 4.401 16.9479 4.24989 16.7638 4.24758L16.7595 4.58093Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M5.28443 2.99528C6.67178 2.78395 8.41647 2.57209 9.79924 2.58239C11.1018 2.59209 12.7438 2.80384 14.0493 3.01027C14.7044 3.11385 15.2791 3.21681 15.6901 3.29389C15.8957 3.33244 16.0604 3.36454 16.174 3.38705C16.2308 3.3983 16.2747 3.40715 16.3046 3.41322L16.3387 3.42017L16.3499 3.42246C16.3499 3.42247 16.3508 3.42264 16.2832 3.74905L16.2156 4.07546L16.2049 4.07326L16.1721 4.06658C16.1432 4.06071 16.1001 4.05205 16.0444 4.041C15.9328 4.01889 15.7703 3.98723 15.5672 3.94914C15.1609 3.87294 14.5926 3.77113 13.9452 3.66876C12.6456 3.46327 11.0445 3.25835 9.79428 3.24904C8.46713 3.23916 6.7659 3.44397 5.38482 3.65435C4.69677 3.75916 4.09275 3.86462 3.66085 3.94386C3.44495 3.98348 3.2722 4.01651 3.15363 4.0396C3.09434 4.05115 3.04861 4.0602 3.01781 4.06635L2.98298 4.07334L2.97218 4.07553L2.90493 3.74905C2.83827 3.42245 2.83831 3.42244 2.83836 3.42243L2.85104 3.41986L2.8873 3.41259C2.91908 3.40624 2.96584 3.39698 3.0262 3.38523C3.1469 3.36172 3.32204 3.32823 3.54054 3.28814C3.97744 3.20798 4.58826 3.10133 5.28443 2.99528ZM2.90493 3.74905L2.83836 3.42243C2.65798 3.45925 2.54151 3.63533 2.57833 3.81571C2.61514 3.99608 2.7918 4.11234 2.97218 4.07553L2.90493 3.74905ZM16.6096 3.81662C16.5723 3.99689 16.3959 4.11278 16.2156 4.07546L16.2832 3.74905L16.3508 3.42264C16.531 3.45996 16.6469 3.63635 16.6096 3.81662Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M3.28464 4.25107C3.46815 4.23644 3.62878 4.37334 3.64341 4.55685L3.31113 4.58335L2.97886 4.60985C2.96422 4.42634 3.10112 4.26571 3.28464 4.25107ZM4.12194 17.0834L3.78903 17.1002L3.77925 16.9095C3.77288 16.7861 3.76358 16.6067 3.75184 16.3828C3.72836 15.9349 3.69511 15.3089 3.65607 14.5966C3.57795 13.1716 3.47669 11.4024 3.38395 10.0224C3.31295 8.96574 3.2117 7.61287 3.12814 6.52347C3.08637 5.97892 3.04905 5.50047 3.02217 5.15816L2.97886 4.60985L3.31113 4.58335L3.64341 4.55685L3.68679 5.10597C3.71369 5.44858 3.75105 5.92744 3.79285 6.47249C3.87644 7.56228 3.97789 8.91775 4.04912 9.97767C4.14215 11.362 4.24359 13.1346 4.32174 14.5601C4.36082 15.2731 4.39409 15.8996 4.41759 16.3479C4.42935 16.572 4.43866 16.7516 4.44503 16.8752L4.4548 17.0656L4.12194 17.0834ZM4.12194 17.0834L3.78903 17.1002C3.79838 17.2841 3.95501 17.4256 4.13887 17.4163C4.32272 17.4069 4.46415 17.2495 4.4548 17.0656L4.12194 17.0834Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M5.60257 16.7254C6.90834 16.7169 8.53454 16.7169 9.80648 16.751C11.2396 16.7895 13.0691 16.894 14.5375 16.9886C15.2723 17.036 15.9178 17.0809 16.3797 17.1141C16.6106 17.1306 16.7956 17.1442 16.923 17.1537L17.1194 17.1685L17.0948 17.5009L17.0693 17.8333L16.8735 17.8185C16.7467 17.8091 16.5623 17.7956 16.332 17.779C15.8714 17.746 15.2275 17.7011 14.4947 17.6539C13.0278 17.5594 11.2086 17.4555 9.78861 17.4174C8.52831 17.3836 6.91129 17.3836 5.60691 17.3921C4.95524 17.3963 4.38257 17.4027 3.97284 17.408C3.76798 17.4106 3.60389 17.413 3.49105 17.4147L3.31753 17.4175L3.31112 17.0842L3.30545 16.7509L3.48089 16.7481C3.59419 16.7464 3.7588 16.744 3.96421 16.7414C4.37503 16.7361 4.94916 16.7297 5.60257 16.7254ZM3.31112 17.0842L3.30545 16.7509C3.12138 16.7541 2.97467 16.9059 2.97783 17.09C2.981 17.274 3.13346 17.4207 3.31753 17.4175L3.31112 17.0842ZM17.4271 17.5263C17.4131 17.7099 17.2529 17.8473 17.0693 17.8333L17.0948 17.5009L17.1202 17.1685C17.3038 17.1826 17.4412 17.3428 17.4271 17.5263Z"
      />
    </svg>
  );
}

function ScribbledEllipseIcon({ size = 20, className }: IconProps) {
  return (
    <svg
      width={size}
      height={size}
      viewBox="0 0 20 20"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      className={className}
    >
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M4.55739 3.93568C7.46902 0.8947 12.2002 1.1564 15.2608 3.91876C16.5142 5.04996 17.2816 6.49066 17.5878 8.01768C18.0083 8.94994 18.234 9.92054 18.249 10.8891C18.2779 12.7636 17.5162 14.6002 15.9043 16.0977C14.392 17.5028 12.5814 18.2375 10.7098 18.2491C9.97219 18.2537 9.22899 18.146 8.49453 17.9255C6.64295 17.767 4.87334 16.9658 3.58343 15.4367C1.676 13.1755 1.2832 10.344 2.28148 7.79433C2.57576 6.38916 3.46976 5.07164 4.55739 3.93568ZM2.42485 10.2275C2.34071 11.9006 2.88716 13.5774 4.093 15.0069C4.3286 15.2861 4.5828 15.5389 4.85254 15.7656C3.68056 14.5772 3.28103 13.0713 3.22018 11.7016C3.04507 11.4605 2.8826 11.214 2.75731 10.9819C2.62124 10.7297 2.51108 10.4781 2.42485 10.2275ZM3.2485 10.4782C2.84526 9.64052 2.76482 8.80019 2.9267 7.97457C3.20512 7.28242 3.59656 6.61183 4.09876 5.98247C6.83382 2.55491 12.419 2.76331 15.4335 6.00168C16.083 6.69948 16.589 7.44767 16.9464 8.21807C17.3965 10.5743 16.656 13.1556 14.8033 14.9846C13.1298 16.6366 10.8047 17.4377 8.61442 17.265C7.6035 16.9502 6.60135 16.3988 5.65306 15.5988C4.68607 14.7829 4.20276 13.7377 4.0001 12.6734C4.13559 12.8295 4.25734 12.9645 4.35215 13.0679C4.41501 13.1364 4.46616 13.1911 4.50176 13.2288L4.54306 13.2724L4.5541 13.2839L4.55706 13.287L4.55788 13.2879C4.6857 13.4204 4.8971 13.4246 5.02959 13.2967C5.16207 13.1689 5.16587 12.9579 5.03807 12.8254C5.03807 12.8254 5.03808 12.8254 5.03807 12.8254L5.03746 12.8248L5.03511 12.8224L5.02535 12.8121L4.98676 12.7714C4.95304 12.7357 4.90399 12.6832 4.84339 12.6172C4.7221 12.485 4.55505 12.2989 4.3723 12.0836C4.21091 11.8934 4.04049 11.6842 3.87965 11.4717C3.87539 11.2461 3.88058 11.0233 3.89318 10.8054C3.9396 10.0027 4.08633 9.28214 4.22199 8.76145C4.2897 8.50157 4.35434 8.29272 4.40167 8.14979C4.42533 8.07836 4.44464 8.02349 4.45781 7.98704C4.4644 7.96882 4.46945 7.95521 4.47274 7.94645L4.47632 7.93698L4.47707 7.93503C4.47705 7.93508 4.47709 7.93498 4.47707 7.93503C4.47705 7.9351 4.4771 7.93496 4.16643 7.81414M12.2502 17.3881C13.3911 17.104 14.4816 16.5096 15.4506 15.6093C16.8479 14.3111 17.5284 12.7623 17.5799 11.1863C17.2636 12.7577 16.4855 14.2608 15.2717 15.459C14.4028 16.3168 13.3632 16.9667 12.2502 17.3881ZM15.4936 5.12111C12.8787 2.70257 8.80143 2.11296 5.76705 3.74252C8.4055 1.71255 12.2223 2.07439 14.8142 4.41366C15.0612 4.63662 15.2876 4.87313 15.4936 5.12111Z"
      />
    </svg>
  );
}

function ScribbledDiamondIcon({ size = 20, className }: IconProps) {
  return (
    <svg
      width={size}
      height={size}
      viewBox="0 0 20 20"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      className={className}
    >
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M11.1077 1.89441C11.212 2.04607 11.1737 2.25361 11.022 2.35797L11.0139 2.36353L10.9891 2.38073C10.9672 2.39597 10.9346 2.41866 10.8925 2.44821C10.8083 2.50731 10.686 2.59381 10.5341 2.70295C10.2302 2.9213 9.80858 3.22993 9.33796 3.59077C8.39262 4.31558 7.26483 5.23952 6.49268 6.06158C5.75373 6.84829 4.9324 7.97618 4.29023 8.91779C3.97053 9.38655 3.69777 9.80539 3.50499 10.1069C3.40863 10.2577 3.33233 10.379 3.28022 10.4625C3.25417 10.5042 3.23417 10.5364 3.22074 10.5582L3.20559 10.5827L3.20093 10.5903C3.10482 10.7473 2.89938 10.7971 2.74236 10.701C2.58535 10.6049 2.53598 10.3997 2.63209 10.2427L2.63771 10.2335L2.65361 10.2077C2.66756 10.1852 2.6881 10.152 2.71472 10.1094C2.76796 10.0241 2.84553 9.90079 2.94329 9.74786C3.13876 9.4421 3.41522 9.01758 3.73945 8.54216C4.38514 7.5954 5.23047 6.43162 6.00676 5.60515C6.81794 4.74154 7.98182 3.79048 8.93232 3.06171C9.40961 2.69576 9.83695 2.38295 10.1451 2.16156C10.2992 2.05083 10.4235 1.96289 10.5096 1.90251C10.5526 1.87232 10.586 1.84901 10.6088 1.83319L10.6349 1.81514L10.6434 1.80924C10.6434 1.80921 10.6441 1.80876 10.8331 2.08336L10.6441 1.80876C10.7958 1.7044 11.0033 1.74275 11.1077 1.89441Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M1.82582 10.6214C1.94287 10.4793 2.15295 10.459 2.29504 10.5761L2.0831 10.8333L1.87116 11.0906C1.72907 10.9736 1.70877 10.7635 1.82582 10.6214ZM9.16643 17.9167L8.90914 18.1286L8.88737 18.1022L8.82364 18.0254C8.768 17.9584 8.68686 17.8611 8.58513 17.7399C8.38164 17.4975 8.09589 17.1598 7.76706 16.7791C7.1079 16.0159 6.28112 15.0861 5.5974 14.4024C4.91367 13.7187 3.98383 12.8919 3.22065 12.2327C2.83993 11.9039 2.5023 11.6181 2.25988 11.4146C2.1387 11.3129 2.04135 11.2318 1.97438 11.1761L1.89753 11.1124L1.87116 11.0906L2.0831 10.8333L2.29504 10.5761L2.32245 10.5987L2.40042 10.6634C2.46817 10.7197 2.56638 10.8015 2.68852 10.904C2.93274 11.1091 3.27283 11.3969 3.65642 11.7282C4.42187 12.3893 5.36702 13.2292 6.0688 13.931C6.77058 14.6328 7.61046 15.5779 8.27159 16.3434C8.60291 16.7269 8.89072 17.067 9.09574 17.3113C9.19826 17.4334 9.28012 17.5316 9.33641 17.5993L9.40107 17.6773L9.4233 17.7042L9.16643 17.9167ZM9.16643 17.9167L8.90914 18.1286C9.0262 18.2707 9.23628 18.291 9.37837 18.174C9.52046 18.0569 9.54035 17.8463 9.4233 17.7042L9.16643 17.9167Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M17.6976 10.1657C17.8365 10.045 18.0471 10.0597 18.1678 10.1987C18.2886 10.3376 18.2739 10.5481 18.1349 10.6689L17.9162 10.4173L17.6976 10.1657ZM9.99958 17.9173L9.76008 17.6855L9.86002 17.5825C9.9246 17.516 10.0185 17.4195 10.1358 17.2992C10.3704 17.0587 10.6989 16.7232 11.0744 16.343C11.8247 15.5834 12.7652 14.6428 13.52 13.9257C14.3177 13.1677 15.3629 12.2271 16.2067 11.4776C16.629 11.1026 17.0016 10.7747 17.2686 10.5406C17.4022 10.4235 17.5093 10.3299 17.5831 10.2654L17.6976 10.1657L17.9162 10.4173L18.1349 10.6689L18.0215 10.7678C17.948 10.8319 17.8412 10.9252 17.7081 11.0419C17.4419 11.2753 17.0704 11.6022 16.6494 11.9761C15.8066 12.7246 14.7684 13.6591 13.9792 14.409C13.2325 15.1184 12.2981 16.0528 11.5487 16.8115C11.1744 17.1905 10.8469 17.525 10.613 17.7648C10.496 17.8846 10.4025 17.9808 10.3382 18.047L10.2395 18.1487L9.99958 17.9173ZM9.99958 17.9173L9.76008 17.6855C9.63205 17.8178 9.63548 18.0288 9.76777 18.1569C9.90005 18.2849 10.1115 18.281 10.2395 18.1487L9.99958 17.9173Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M8.86605 1.93879C8.94592 1.77293 9.14513 1.70321 9.31099 1.78308L9.16638 2.08341C9.31099 1.78308 9.31095 1.78306 9.31099 1.78308L9.31301 1.78405L9.31817 1.78655L9.33763 1.79603C9.35457 1.80431 9.37932 1.81647 9.41107 1.83223C9.47457 1.86376 9.56614 1.90976 9.67943 1.9681C9.90588 2.08472 10.2198 2.251 10.57 2.44996C11.2644 2.84444 12.1242 3.37987 12.7228 3.91908C13.7803 4.87171 14.411 5.77009 15.1185 6.77795C15.4184 7.20516 15.7321 7.65205 16.0979 8.13108C16.36 8.47421 16.6824 9.01299 16.9328 9.45249C17.0596 9.67498 17.1707 9.87686 17.2501 10.0231C17.2898 10.0963 17.3217 10.1556 17.3437 10.1968L17.369 10.2444L17.3756 10.257L17.3778 10.2611C17.4636 10.4241 17.4012 10.626 17.2383 10.7117C17.0754 10.7975 16.8738 10.7349 16.7881 10.572C16.7881 10.572 16.7881 10.572 16.7881 10.572L16.7861 10.5682L16.7799 10.5565L16.7555 10.5107C16.7342 10.4708 16.7031 10.4128 16.6642 10.3412C16.5864 10.1978 16.4776 10.0001 16.3536 9.78259C16.1026 9.34207 15.7999 8.83917 15.5681 8.53574C15.1665 8.00993 14.837 7.54007 14.5307 7.10341C13.845 6.12584 13.2759 5.31463 12.2766 4.41441C11.7346 3.92618 10.9278 3.41994 10.2407 3.02962C9.90015 2.83617 9.59455 2.67427 9.37421 2.56079C9.2641 2.50409 9.17545 2.45957 9.11458 2.42934C9.08414 2.41423 9.06066 2.4027 9.04493 2.39501L9.02723 2.38639L9.02293 2.3843L9.02195 2.38383C9.02194 2.38383 9.02196 2.38383 9.02195 2.38383C8.8561 2.30395 8.78618 2.10465 8.86605 1.93879Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M10.1351 1.77876C10.3033 1.85355 10.379 2.05054 10.3042 2.21876L9.99966 2.08335C10.3042 2.21876 10.3043 2.21867 10.3042 2.21876L10.3038 2.21976L10.303 2.22152L10.3004 2.2273L10.291 2.24778C10.2828 2.26534 10.2709 2.29066 10.255 2.32333C10.2233 2.38866 10.1759 2.48339 10.1117 2.60425C9.9834 2.84595 9.78793 3.19226 9.51656 3.61699C8.97388 4.46634 8.12722 5.63001 6.90645 6.89788C5.76129 8.08722 4.70343 8.93382 3.92952 9.48433C3.54251 9.75963 3.22631 9.96102 3.00544 10.0943C2.89499 10.161 2.80836 10.2106 2.7486 10.244C2.71871 10.2607 2.69555 10.2733 2.67948 10.2819L2.66074 10.2919L2.65545 10.2947L2.65384 10.2955L2.65309 10.2959C2.65301 10.296 2.65293 10.296 2.49966 10L2.65309 10.2959C2.48961 10.3806 2.2883 10.3168 2.20366 10.1533C2.11903 9.98984 2.18288 9.78875 2.34627 9.70407C2.34623 9.70409 2.34631 9.70405 2.34627 9.70407L2.34968 9.70228L2.36383 9.69474C2.37682 9.68775 2.39686 9.67685 2.42359 9.66193C2.47703 9.63209 2.55716 9.5862 2.66095 9.52356C2.86854 9.39827 3.17066 9.206 3.54309 8.94108C4.28804 8.41117 5.31352 7.5911 6.42621 6.43548C7.61256 5.20335 8.43257 4.07535 8.95477 3.25804C9.21585 2.84943 9.40237 2.51866 9.52292 2.29161C9.5832 2.1781 9.62696 2.09053 9.6553 2.03217C9.66947 2.00298 9.67978 1.9811 9.68636 1.96693L9.69346 1.9515L9.69495 1.94821C9.76978 1.78008 9.9669 1.70399 10.1351 1.77876Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2.20044 11.1035C2.28101 10.938 2.48051 10.8691 2.64604 10.9497L2.65448 10.9538L2.67799 10.9654C2.69853 10.9755 2.72864 10.9904 2.76738 11.0097C2.84485 11.0484 2.95685 11.1047 3.09572 11.176C3.37337 11.3186 3.75901 11.5212 4.19138 11.7614C5.05137 12.2392 6.11398 12.8756 6.87603 13.4899C7.75522 14.1987 8.71011 15.2618 9.43707 16.1347C9.80256 16.5736 10.1142 16.969 10.3345 17.2547C10.4447 17.3977 10.5322 17.5133 10.5923 17.5934C10.6223 17.6335 10.6455 17.6647 10.6613 17.686L10.6793 17.7104L10.684 17.7167L10.6852 17.7184C10.6853 17.7185 10.6857 17.7191 10.4168 17.9161L10.6857 17.7191C10.7945 17.8676 10.7623 18.0762 10.6138 18.185C10.4653 18.2938 10.2567 18.2616 10.1479 18.1131C10.1479 18.1131 10.1479 18.1131 10.1479 18.1131L10.1425 18.1057L10.1256 18.0828C10.1105 18.0625 10.0881 18.0324 10.0589 17.9934C10.0004 17.9154 9.91477 17.8021 9.80657 17.6618C9.59008 17.381 9.28376 16.9924 8.92478 16.5613C8.20281 15.6944 7.2827 14.6741 6.45761 14.0089C5.74236 13.4323 4.72163 12.8186 3.86761 12.3442C3.44298 12.1083 3.06395 11.9092 2.79118 11.7691C2.65485 11.6991 2.54519 11.6439 2.46982 11.6063C2.43213 11.5875 2.40303 11.5731 2.38345 11.5635L2.36135 11.5526L2.3546 11.5493"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M10.3149 2.38886C10.4893 2.32971 10.6785 2.42308 10.7377 2.59741L10.422 2.70452L10.1064 2.81163C10.0472 2.6373 10.1406 2.44802 10.3149 2.38886ZM10.422 2.70452C10.1064 2.81163 10.1064 2.81156 10.1064 2.81163L10.108 2.8163L10.1124 2.82938L10.1298 2.87998C10.1452 2.92432 10.1678 2.98953 10.1974 3.07354C10.2565 3.24157 10.3432 3.48485 10.4541 3.78682C10.6757 4.39063 10.9939 5.22977 11.3805 6.17156C12.1512 8.04929 13.2023 10.3568 14.3082 12.0168C14.83 12.7999 15.5668 13.7434 16.1684 14.486C16.4702 14.8584 16.7397 15.1824 16.9338 15.4134C17.0308 15.5289 17.1091 15.6212 17.1632 15.6847L17.2255 15.7577L17.2471 15.7829C17.3672 15.9225 17.5781 15.9387 17.7176 15.8186C17.8571 15.6985 17.8729 15.488 17.7528 15.3485L17.7476 15.3425L17.7319 15.3241L17.6708 15.2525C17.6175 15.19 17.5402 15.0988 17.4441 14.9845C17.252 14.7558 16.9851 14.435 16.6864 14.0663C16.0871 13.3267 15.3667 12.4031 14.863 11.6472C13.7957 10.0451 12.765 7.78891 11.9972 5.91841C11.6145 4.98608 11.2994 4.15499 11.0799 3.5571C10.9702 3.25822 10.8845 3.01778 10.8263 2.85229C10.7971 2.76955 10.7749 2.70557 10.76 2.6624L10.7432 2.61351L10.739 2.60126L10.7377 2.59741L10.422 2.70452Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2.61027 17.5168C2.43001 17.5541 2.25355 17.4382 2.21619 17.2579C2.17883 17.0776 2.29468 16.9013 2.47494 16.864L2.54259 17.1904C2.47496 16.864 2.47489 16.864 2.47494 16.864L2.49141 16.8606L2.53887 16.8509C2.58054 16.8424 2.64195 16.83 2.7213 16.8142C2.87999 16.7825 3.11044 16.7372 3.3981 16.6823C3.97333 16.5726 4.77773 16.4247 5.69478 16.2721C7.52506 15.9674 9.81818 15.6413 11.634 15.5644C12.7876 15.5156 14.259 15.5457 15.4363 15.5876C16.0262 15.6086 16.5444 15.6325 16.9153 15.6513C17.1008 15.6607 17.2495 15.6688 17.3519 15.6745L17.4696 15.6812L17.5102 15.6836C17.6939 15.6947 17.8347 15.8527 17.8236 16.0365C17.8126 16.2202 17.6547 16.3602 17.4709 16.3491L17.4311 16.3467L17.3149 16.3401C17.2136 16.3344 17.0661 16.3264 16.8819 16.3171C16.5136 16.2985 15.9987 16.2746 15.4129 16.2538C14.2389 16.2121 12.7889 16.1828 11.6625 16.2305C9.88958 16.3055 7.62989 16.6259 5.80453 16.9297C4.89375 17.0813 4.09463 17.2282 3.52328 17.3372C3.23765 17.3916 3.00905 17.4366 2.85202 17.4679C2.77351 17.4836 2.71289 17.4959 2.67198 17.5042L2.62565 17.5136L2.61027 17.5168Z"
      />
    </svg>
  );
}

function ScribbledTriangleIcon({ size = 20, className }: IconProps) {
  return (
    <svg
      width={size}
      height={size}
      viewBox="0 0 20 20"
      fill="currentColor"
      xmlns="http://www.w3.org/2000/svg"
      className={className}
    >
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M10.1042 1.55591C10.2801 1.61017 10.3787 1.79676 10.3245 1.97268L10.0059 1.87444L9.6874 1.7762C9.74166 1.60028 9.92825 1.50165 10.1042 1.55591ZM2.92782 15.5656L2.66613 15.3592L2.67298 15.3505L2.69374 15.324C2.71206 15.3007 2.7392 15.2659 2.77423 15.2209C2.84431 15.1308 2.94597 14.9995 3.07196 14.8347C3.32399 14.5053 3.6731 14.0427 4.0612 13.5107C4.83961 12.4437 5.76667 11.1085 6.38444 10.0089C7.22603 8.51089 8.05125 6.4576 8.66899 4.76689C8.97699 3.92394 9.23181 3.17556 9.4096 2.63803C9.49848 2.36931 9.56806 2.15343 9.61536 2.00491C9.63902 1.93066 9.65709 1.87326 9.66922 1.83453L9.68291 1.79067L9.6874 1.7762L10.0059 1.87444C10.3245 1.97268 10.3245 1.97262 10.3245 1.97268L10.3241 1.97381L10.3195 1.98852L10.3054 2.0338C10.293 2.0735 10.2746 2.13192 10.2506 2.20723C10.2026 2.35785 10.1323 2.5761 10.0425 2.84738C9.86313 3.38983 9.60604 4.14488 9.29517 4.99568C8.67521 6.69249 7.835 8.78805 6.96567 10.3354C6.32758 11.4712 5.38103 12.8327 4.59978 13.9036C4.20806 14.4406 3.85583 14.9073 3.60148 15.2398C3.47429 15.4061 3.3715 15.5389 3.30042 15.6303C3.26488 15.6759 3.23727 15.7113 3.21848 15.7352L3.19704 15.7626L3.19006 15.7714L2.92782 15.5656ZM2.92782 15.5656L2.66613 15.3592C2.55211 15.5037 2.57684 15.7133 2.72137 15.8274C2.86591 15.9414 3.07551 15.9166 3.18953 15.7721L2.92782 15.5656Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M5.15809 16.0728C6.66763 16.0543 8.54993 16.0541 10.0224 16.1288C11.5853 16.2081 13.5722 16.4167 15.1634 16.6046C15.9601 16.6987 16.6596 16.7879 17.1599 16.8535C17.4101 16.8863 17.6106 16.9133 17.7486 16.932L17.9071 16.9537L17.9624 16.9614C18.1448 16.9869 18.272 17.1554 18.2465 17.3377C18.221 17.52 18.0525 17.6471 17.8702 17.6216L17.816 17.6141L17.6588 17.5926C17.5217 17.574 17.3223 17.5472 17.0732 17.5145C16.575 17.4492 15.8785 17.3604 15.0853 17.2667C13.4967 17.0791 11.5282 16.8728 9.98864 16.7947C8.53815 16.7211 6.67322 16.7209 5.16628 16.7394C4.4138 16.7487 3.7524 16.7626 3.27918 16.7741C3.04259 16.7799 2.85308 16.7851 2.72281 16.7889L2.57336 16.7933L2.52264 16.7949L2.51107 16.4618L2.50033 16.1286L2.55289 16.1269L2.70361 16.1225C2.83476 16.1187 3.02524 16.1135 3.26289 16.1077C3.73816 16.096 4.40233 16.0821 5.15809 16.0728ZM2.17791 16.4726C2.17194 16.2886 2.31633 16.1346 2.50033 16.1286L2.51107 16.4618L2.52264 16.7949C2.33865 16.8009 2.18388 16.6566 2.17791 16.4726Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M8.94721 2.04509C9.08267 1.92043 9.29354 1.92918 9.41821 2.06464L9.17293 2.29037L8.92766 2.51609C8.803 2.38063 8.81175 2.16976 8.94721 2.04509ZM17.5001 16.3965L17.1832 16.4996L17.1792 16.4874L17.1669 16.4503C17.1561 16.4175 17.14 16.3688 17.1189 16.3058C17.0767 16.1799 17.0146 15.9968 16.9356 15.7688C16.7775 15.3128 16.5516 14.6777 16.2801 13.9621C15.7356 12.5263 15.0142 10.7827 14.2952 9.50708C13.4583 8.02226 12.1209 6.27766 10.9829 4.89499C10.4157 4.20581 9.90135 3.61049 9.52889 3.18756C9.34269 2.97614 9.19206 2.80792 9.08812 2.69271C9.03616 2.63511 8.99587 2.59077 8.96866 2.56093L8.93783 2.52718L8.92766 2.51609L9.17293 2.29037C9.41821 2.06464 9.41816 2.06459 9.41821 2.06464L9.42942 2.07686L9.46134 2.1118C9.48929 2.14246 9.53035 2.18765 9.58312 2.24614C9.68866 2.36312 9.84107 2.53334 10.0292 2.74696C10.4054 3.17409 10.9247 3.77517 11.4976 4.47135C12.64 5.85938 14.0089 7.64131 14.876 9.17975C15.6209 10.5013 16.3567 12.2842 16.9035 13.7257C17.1777 14.4486 17.4059 15.0899 17.5655 15.5505C17.6454 15.7808 17.7081 15.9661 17.751 16.094C17.7724 16.158 17.7889 16.2076 17.8 16.2413L17.8127 16.2798L17.817 16.2932C17.8171 16.2932 17.8171 16.2933 17.5001 16.3965ZM17.5001 16.3965L17.1832 16.4996C17.2401 16.6747 17.4283 16.7704 17.6033 16.7134C17.7784 16.6564 17.874 16.4682 17.817 16.2932L17.5001 16.3965Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M9.73652 3.33805C9.84503 3.18934 10.0536 3.15674 10.2023 3.26525C10.351 3.37377 10.3836 3.58229 10.2751 3.731L10.0058 3.53453L9.73652 3.33805ZM3.76041 15.5662L3.44364 15.4624L3.44694 15.4524L3.4565 15.4234L3.4934 15.3123C3.52562 15.2158 3.57267 15.0759 3.63218 14.9017C3.75116 14.5534 3.92007 14.0677 4.11982 13.5182C4.51824 12.422 5.04339 11.0605 5.54203 10.0278C6.21751 8.62874 7.26905 6.95347 8.14522 5.63598C8.5845 4.97543 8.98196 4.40146 9.26965 3.99255C9.41352 3.78805 9.53001 3.62474 9.61064 3.51241C9.65096 3.45624 9.68231 3.41281 9.70364 3.38334L9.72799 3.34977L9.73652 3.33805C9.73655 3.33801 9.73652 3.33805 10.0058 3.53453L10.2751 3.731L10.2673 3.74174L10.2436 3.77428C10.2228 3.80305 10.192 3.84574 10.1522 3.90114C10.0727 4.01194 9.95745 4.17354 9.81489 4.37615C9.52974 4.78146 9.13569 5.35051 8.70034 6.00515C7.82723 7.31804 6.79698 8.96185 6.14238 10.3176C5.65914 11.3185 5.14339 12.6537 4.74638 13.7459C4.54842 14.2905 4.38098 14.772 4.26305 15.1172C4.20409 15.2898 4.15754 15.4282 4.12577 15.5234L4.0895 15.6326L4.08024 15.6606L4.07736 15.6694L3.76041 15.5662ZM3.76041 15.5662L3.44364 15.4624C3.38636 15.6374 3.48174 15.8257 3.6567 15.883C3.83166 15.9403 4.02009 15.8444 4.07736 15.6694L3.76041 15.5662Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M10.3149 2.38886C10.4893 2.32971 10.6785 2.42308 10.7377 2.59741L10.422 2.70452L10.1064 2.81163C10.0472 2.6373 10.1406 2.44802 10.3149 2.38886ZM10.422 2.70452C10.1064 2.81163 10.1064 2.81156 10.1064 2.81163L10.108 2.8163L10.1124 2.82938L10.1298 2.87998C10.1452 2.92432 10.1678 2.98953 10.1974 3.07354C10.2565 3.24157 10.3432 3.48485 10.4541 3.78682C10.6757 4.39063 10.9939 5.22977 11.3805 6.17156C12.1512 8.04929 13.2023 10.3568 14.3082 12.0168C14.83 12.7999 15.5668 13.7434 16.1684 14.486C16.4702 14.8584 16.7397 15.1824 16.9338 15.4134C17.0308 15.5289 17.1091 15.6212 17.1632 15.6847L17.2255 15.7577L17.2471 15.7829C17.3672 15.9225 17.5781 15.9387 17.7176 15.8186C17.8571 15.6985 17.8729 15.488 17.7528 15.3485L17.7476 15.3425L17.7319 15.3241L17.6708 15.2525C17.6175 15.19 17.5402 15.0988 17.4441 14.9845C17.252 14.7558 16.9851 14.435 16.6864 14.0663C16.0871 13.3267 15.3667 12.4031 14.863 11.6472C13.7957 10.0451 12.765 7.78891 11.9972 5.91841C11.6145 4.98608 11.2994 4.15499 11.0799 3.5571C10.9702 3.25822 10.8845 3.01778 10.8263 2.85229C10.7971 2.76955 10.7749 2.70557 10.76 2.6624L10.7432 2.61351L10.739 2.60126L10.7377 2.59741L10.422 2.70452Z"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M2.61027 17.5168C2.43001 17.5541 2.25355 17.4382 2.21619 17.2579C2.17883 17.0776 2.29468 16.9013 2.47494 16.864L2.54259 17.1904C2.47496 16.864 2.47489 16.864 2.47494 16.864L2.49141 16.8606L2.53887 16.8509C2.58054 16.8424 2.64195 16.83 2.7213 16.8142C2.87999 16.7825 3.11044 16.7372 3.3981 16.6823C3.97333 16.5726 4.77773 16.4247 5.69478 16.2721C7.52506 15.9674 9.81818 15.6413 11.634 15.5644C12.7876 15.5156 14.259 15.5457 15.4363 15.5876C16.0262 15.6086 16.5444 15.6325 16.9153 15.6513C17.1008 15.6607 17.2495 15.6688 17.3519 15.6745L17.4696 15.6812L17.5102 15.6836C17.6939 15.6947 17.8347 15.8527 17.8236 16.0365C17.8126 16.2202 17.6547 16.3602 17.4709 16.3491L17.4311 16.3467L17.3149 16.3401C17.2136 16.3344 17.0661 16.3264 16.8819 16.3171C16.5136 16.2985 15.9987 16.2746 15.4129 16.2538C14.2389 16.2121 12.7889 16.1828 11.6625 16.2305C9.88958 16.3055 7.62989 16.6259 5.80453 16.9297C4.89375 17.0813 4.09463 17.2282 3.52328 17.3372C3.23765 17.3916 3.00905 17.4366 2.85202 17.4679C2.77351 17.4836 2.71289 17.4959 2.67198 17.5042L2.62565 17.5136L2.61027 17.5168Z"
      />
    </svg>
  );
}

function BrushToolIcon({ className, style }: { className?: string; style?: CSSProperties }) {
  return <InlineSvgFile src={BRUSH_SVG_SRC} className={className} style={style} />;
}

function HighlighterToolIcon({
  className,
  style,
}: {
  className?: string;
  style?: CSSProperties;
}) {
  return <InlineSvgFile src={HIGHLIGHTER_SVG_SRC} className={className} style={style} />;
}

function EraserToolIcon({ className }: { className?: string }) {
  return <InlineSvgFile src={ERASER_SVG_SRC} className={className} />;
}

const INSERT_ITEMS: InsertItem[] = [
  {
    id: "note",
    title: "Note",
    description: "Quick note placeholder card.",
    icon: PageIcon,
    size: [260, 180],
  },
  {
    id: "image",
    title: "Image",
    description: "Image placeholder block.",
    icon: ImageIcon,
    size: [320, 220],
    opensPicker: true,
  },
  {
    id: "calendar",
    title: "Calendar",
    description: "Calendar panel block.",
    icon: CalendarIcon,
    nodeType: "calendar",
    props: {},
    size: [360, 320],
  },
  {
    id: "sticker",
    title: "Sticker",
    description: "Sticker placeholder block.",
    icon: NoteShadowDuotoneIcon,
    size: [200, 200],
  },
  {
    id: "video",
    title: "Video",
    description: "Video placeholder block.",
    icon: MoviePanelIcon,
    size: [360, 220],
  },
];

const SHAPE_ITEMS: ShapeItem[] = [
  {
    id: "shape-rect",
    title: "Rectangle",
    description: "Rectangle placeholder block.",
    icon: ScribbledSquareIcon,
    size: [260, 180],
  },
  {
    id: "shape-circle",
    title: "Ellipse",
    description: "Ellipse placeholder block.",
    icon: ScribbledEllipseIcon,
    size: [240, 240],
  },
  {
    id: "shape-triangle",
    title: "Triangle",
    description: "Triangle placeholder block.",
    icon: ScribbledTriangleIcon,
    size: [240, 200],
  },
  {
    id: "shape-diamond",
    title: "Diamond",
    description: "Diamond placeholder block.",
    icon: ScribbledDiamondIcon,
    size: [240, 200],
  },
];

/** Render the bottom toolbar for the board canvas. */
const BoardToolbar = memo(function BoardToolbar({ engine, snapshot }: BoardToolbarProps) {
  // 悬停展开的组 id（用字符串常量标识）
  const [hoverGroup, setHoverGroup] = useState<string | null>(null);
  const toolbarRef = useRef<HTMLDivElement | null>(null);
  const imageInputRef = useRef<HTMLInputElement | null>(null);
  const isSelectTool = snapshot.activeToolId === "select";
  const isHandTool = snapshot.activeToolId === "hand";
  const isPenTool = snapshot.activeToolId === "pen" || snapshot.activeToolId === "highlighter";
  const isEraserTool = snapshot.activeToolId === "eraser";
  const isLocked = snapshot.locked;
  const pendingInsert = snapshot.pendingInsert;
  const penPanelOpen = !isLocked && (hoverGroup === "pen" || isPenTool);

  const [penVariant, setPenVariant] = useState<"pen" | "highlighter">("pen");
  const [penSize, setPenSize] = useState<number>(6);
  const [penColor, setPenColor] = useState<string>("#f59e0b");
  const selectTitle = buildToolTitle(TOOL_LABELS.select, TOOL_SHORTCUTS.select);
  const handTitle = buildToolTitle(TOOL_LABELS.hand, TOOL_SHORTCUTS.hand);
  const penTitle = buildToolTitle(TOOL_LABELS.pen, TOOL_SHORTCUTS.pen);
  const highlighterTitle = buildToolTitle(
    TOOL_LABELS.highlighter,
    TOOL_SHORTCUTS.highlighter
  );
  const eraserTitle = buildToolTitle(TOOL_LABELS.eraser, TOOL_SHORTCUTS.eraser);
  const shapeTitle = TOOL_LABELS.shape;
  const toolbarDragRef = useRef<{
    request: CanvasInsertRequest;
    startX: number;
    startY: number;
    moved: boolean;
  } | null>(null);
  const [toolbarDragging, setToolbarDragging] = useState(false);

  useEffect(() => {
    // 逻辑：同步画笔配置到画布引擎，保持绘制体验一致。
    engine.setPenSettings({ size: penSize, color: penColor, opacity: 1 });
    engine.setHighlighterSettings({ size: penSize, color: penColor, opacity: 0.35 });
  }, [engine, penColor, penSize]);

  useEffect(() => {
    if (snapshot.activeToolId === "pen") {
      setPenVariant("pen");
    } else if (snapshot.activeToolId === "highlighter") {
      setPenVariant("highlighter");
    }
  }, [snapshot.activeToolId]);

  useEffect(() => {
    if (!isLocked) return;
    // 逻辑：锁定画布时关闭悬浮面板，避免残留交互入口。
    setHoverGroup(null);
  }, [isLocked]);

  useEffect(() => {
    if (!hoverGroup) return;
    const handlePointerDown = (event: PointerEvent) => {
      const target = event.target as Node | null;
      const container = toolbarRef.current;
      if (!container || !target) return;
      // 逻辑：点击工具条外部时关闭子面板。
      if (container.contains(target)) return;
      if (hoverGroup === "pen" && isPenTool) return;
      setHoverGroup(null);
    };
    document.addEventListener("pointerdown", handlePointerDown, { capture: true });
    return () => {
      document.removeEventListener("pointerdown", handlePointerDown, { capture: true });
    };
  }, [hoverGroup, isPenTool]);

  const handleToolChange = useCallback(
    (tool: ToolMode, options?: { keepPanel?: boolean }) => {
      if (isLocked && (tool === "pen" || tool === "highlighter" || tool === "eraser")) {
        return;
      }
      engine.setActiveTool(tool);
      if (tool === "pen" || tool === "highlighter") {
        setPenVariant(tool);
      }
      if (!options?.keepPanel) {
        setHoverGroup(null);
      }
    },
    [engine, isLocked]
  );

  /** Update pending insert requests for one-shot placement. */
  const handleInsertRequest = useCallback(
    (request: CanvasInsertRequest) => {
      if (isLocked) return;
      engine.getContainer()?.focus();
      if (pendingInsert?.id === request.id) {
        engine.setPendingInsert(null);
        return;
      }
      engine.setPendingInsert(request);
      setHoverGroup(null);
    },
    [engine, isLocked, pendingInsert?.id]
  );


  const getWorldPointFromEvent = useCallback(
    (event: PointerEvent | React.PointerEvent<HTMLButtonElement>) => {
      const container = engine.getContainer();
      if (!container) return null;
      const rect = container.getBoundingClientRect();
      return engine.screenToWorld([
        event.clientX - rect.left,
        event.clientY - rect.top,
      ]);
    },
    [engine]
  );

  const placeInsertAtPoint = useCallback(
    (request: CanvasInsertRequest, point: [number, number]) => {
      const [width, height] = request.size ?? [320, 180];
      engine.addNodeElement(request.type, request.props, [
        point[0] - width / 2,
        point[1] - height / 2,
        width,
        height,
      ]);
      engine.setPendingInsert(null);
    },
    [engine]
  );

  useEffect(() => {
    if (!toolbarDragging) return;
    const handlePointerMove = (event: PointerEvent) => {
      const drag = toolbarDragRef.current;
      if (!drag) return;
      const dx = event.clientX - drag.startX;
      const dy = event.clientY - drag.startY;
      if (!drag.moved && Math.hypot(dx, dy) > 4) {
        drag.moved = true;
      }
      if (!drag.moved) return;
      const worldPoint = getWorldPointFromEvent(event);
      if (worldPoint) {
        engine.setPendingInsertPoint(worldPoint);
      }
    };
    const handlePointerUp = (event: PointerEvent) => {
      const drag = toolbarDragRef.current;
      toolbarDragRef.current = null;
      setToolbarDragging(false);
      engine.setToolbarDragging(false);
      if (!drag || !drag.moved) {
        if (drag && drag.request.id === "note" && !engine.isLocked()) {
          engine.setPendingInsert(drag.request);
        }
        return;
      }
      const worldPoint = getWorldPointFromEvent(event);
      if (!worldPoint || engine.isLocked()) {
        engine.setPendingInsert(null);
        return;
      }
      if (isBoardUiTarget(event.target, ["[data-board-node]"])) {
        engine.setPendingInsert(null);
        return;
      }
      placeInsertAtPoint(drag.request, worldPoint);
    };
    document.addEventListener("pointermove", handlePointerMove, { capture: true });
    document.addEventListener("pointerup", handlePointerUp, { capture: true });
    return () => {
      document.removeEventListener("pointermove", handlePointerMove, { capture: true });
      document.removeEventListener("pointerup", handlePointerUp, { capture: true });
    };
  }, [engine, getWorldPointFromEvent, placeInsertAtPoint, toolbarDragging]);

  /** Trigger the native image picker. */
  const handlePickImage = useCallback(() => {
    if (isLocked) return;
    imageInputRef.current?.click();
  }, [isLocked]);

  /** Handle inserting selected image files. */
  const handleImageChange = useCallback(
    async (event: ChangeEvent<HTMLInputElement>) => {
      const file = event.target.files?.[0];
      if (!file) return;
      try {
        const payload = await engine.buildImagePayloadFromFile(file);
        handleInsertRequest({
          id: "image",
          type: "image",
          props: payload.props,
          size: payload.size,
        });
      } finally {
        // 逻辑：清空输入，保证再次选择同一文件可触发 change
        event.target.value = "";
      }
    },
    [engine, handleInsertRequest]
  );

  // 统一按钮尺寸（“宽松”密度）
  const iconSize = 20;
  /** 底部工具栏图标尺寸。 */
  const toolbarIconSize = 22;
  /** 底部工具栏图标 hover 放大样式。 */
  const toolbarIconClassName =
    "origin-center transition-transform duration-150 ease-out group-hover:scale-[1.2]";

  return (
    <div
      ref={toolbarRef}
      data-canvas-toolbar
      onPointerDown={event => {
        // 逻辑：阻止工具条交互触发画布选择。
        event.stopPropagation();
      }}
      className={cn(
        "pointer-events-auto absolute bottom-4 left-1/2 z-20 -translate-x-1/2",
        "h-12 rounded-[14px] bg-background/80 px-2 ring-1 ring-border/80 backdrop-blur-md"
      )}
    >
      <div className="relative flex h-full items-center gap-2">
        {/* 左侧：持久工具 */}
        <div className="flex items-center gap-2">
          <IconBtn
            title={selectTitle}
            active={isSelectTool}
            onPointerDown={() => handleToolChange("select")}
            className="group h-8 w-8"
          >
            <SelectIcon size={toolbarIconSize} className={toolbarIconClassName} />
          </IconBtn>
          <IconBtn
            title={handTitle}
            active={isHandTool}
            onPointerDown={() => handleToolChange("hand")}
            className="group h-8 w-8"
          >
            <HandIcon size={toolbarIconSize} className={toolbarIconClassName} />
          </IconBtn>
          <span className="h-8 w-px bg-border/80" />
          <div className="relative">
            <IconBtn
              title={penVariant === "highlighter" ? highlighterTitle : penTitle}
              active={isPenTool || hoverGroup === "pen"}
              onPointerDown={() => {
                if (isLocked) return;
                setHoverGroup("pen");
                handleToolChange(penVariant, { keepPanel: true });
              }}
              className="group h-10 w-9 overflow-hidden"
              disabled={isLocked}
            >
              <span className="relative">
                {penVariant === "highlighter" ? (
                  <HighlighterToolIcon
                    className={cn(
                      "h-10 w-5 transition-transform duration-300 ease-in-out group-hover:translate-y-0",
                      isPenTool ? "translate-y-0" : "translate-y-2"
                    )}
                    style={{ color: penColor }}
                  />
                ) : (
                  <BrushToolIcon
                    className={cn(
                      "h-10 w-5 transition-transform duration-300 ease-in-out group-hover:translate-y-0",
                      isPenTool ? "translate-y-0" : "translate-y-2"
                    )}
                    style={{ color: penColor }}
                  />
                )}
              </span>
            </IconBtn>
            <HoverPanel open={penPanelOpen} className="w-max">
              <div className="flex items-center gap-2">
                <div className="flex items-center gap-1.5">
                  <PanelItem
                    title={penTitle}
                    active={snapshot.activeToolId === "pen"}
                    onPointerDown={() => handleToolChange("pen")}
                    size="sm"
                    showLabel={false}
                  >
                    <BrushToolIcon className="h-8 w-4" style={{ color: penColor }} />
                  </PanelItem>
                  <PanelItem
                    title={highlighterTitle}
                    active={snapshot.activeToolId === "highlighter"}
                    onPointerDown={() => handleToolChange("highlighter")}
                    size="sm"
                    showLabel={false}
                  >
                    <HighlighterToolIcon className="h-8 w-4" style={{ color: penColor }} />
                  </PanelItem>
                </div>
                <span className="h-6 w-px bg-border/70" />
                <div className="flex items-center gap-2">
                  {PEN_SIZES.map(size => (
                    <button
                      key={`pen-size-${size}`}
                      type="button"
                      onPointerDown={event => {
                        event.stopPropagation();
                        if (isLocked) return;
                        setPenSize(size);
                      }}
                        className={cn(
                          "inline-flex h-7 w-7 items-center justify-center rounded-full",
                          penSize === size
                            ? "bg-foreground/12 text-foreground dark:bg-foreground/18 dark:text-background"
                            : "hover:bg-accent/60"
                        )}
                      aria-label={`Pen size ${size}`}
                    >
                      <span className="rounded-full bg-current" style={{ width: size, height: size }} />
                    </button>
                  ))}
                </div>
                <span className="h-6 w-px bg-border/70" />
                <div className="flex items-center gap-1.5">
                  {PEN_COLORS.map(color => (
                    <button
                      key={`pen-color-${color}`}
                      type="button"
                      onPointerDown={event => {
                        event.stopPropagation();
                        if (isLocked) return;
                        setPenColor(color);
                      }}
                      className={cn(
                        "h-6 w-6 rounded-full ring-1 ring-border",
                        penColor === color &&
                          "ring-2 ring-foreground ring-offset-2 ring-offset-background shadow-[0_0_0_2px_rgba(255,255,255,0.9)]"
                      )}
                      style={{ backgroundColor: color }}
                      aria-label={`Pen color ${color}`}
                    />
                  ))}
                </div>
              </div>
            </HoverPanel>
          </div>
          <IconBtn
            title={eraserTitle}
            active={isEraserTool}
            onPointerDown={() => {
              if (isLocked) return;
              handleToolChange("eraser");
            }}
            className="group h-10 w-9 overflow-hidden"
            disabled={isLocked}
          >
            <EraserToolIcon
              className={cn(
                "h-10 w-8 transition-transform duration-300 ease-in-out group-hover:translate-y-0",
                isEraserTool ? "translate-y-0" : "translate-y-2"
              )}
            />
          </IconBtn>
        </div>

        <span className="h-8 w-px bg-border/80" />

        {/* 右侧：一次性插入 */}
        <div className="flex items-center gap-2">
          <div className="relative">
            <IconBtn
              title={shapeTitle}
              active={hoverGroup === "shape"}
              onPointerDown={() => {
                if (isLocked) return;
                setHoverGroup(current => (current === "shape" ? null : "shape"));
              }}
              className="group h-8 w-8"
              disabled={isLocked}
            >
              <ShapeIcon size={toolbarIconSize} className={toolbarIconClassName} />
            </IconBtn>
            <HoverPanel open={hoverGroup === "shape"} className="w-max">
              <div className="flex items-center gap-1.5">
                {SHAPE_ITEMS.map(item => {
                  const Icon = item.icon;
                  return (
                    <PanelItem
                      key={item.id}
                      title={SHAPE_TOOL_LABELS[item.id] ?? item.title}
                      onPointerDown={() => {
                        handleInsertRequest({
                          id: item.id,
                          type: "placeholder",
                          props: {
                            title: item.title,
                            description: item.description,
                          },
                          size: item.size,
                        });
                      }}
                      size="sm"
                      showLabel={false}
                    >
                      <Icon size={iconSize} />
                    </PanelItem>
                  );
                })}
              </div>
            </HoverPanel>
          </div>
          {INSERT_ITEMS.map(item => {
            const Icon = item.icon;
            const isActive = pendingInsert?.id === item.id;
            const request: CanvasInsertRequest = {
              id: item.id,
              type: item.nodeType ?? "placeholder",
              props: item.props ?? {
                title: item.title,
                description: item.description,
              },
              size: item.size,
            };
            return (
              <IconBtn
                key={item.id}
                title={INSERT_TOOL_LABELS[item.id] ?? item.title}
                active={isActive}
                onPointerDown={event => {
                  if (isLocked) return;
                  if (item.id === "note") {
                    engine.getContainer()?.focus();
                    if (pendingInsert?.id === item.id) {
                      engine.setPendingInsert(null);
                      engine.setToolbarDragging(false);
                      return;
                    }
                    engine.setSelectionBox(null);
                    engine.setAlignmentGuides([]);
                    engine.setPendingInsert(request);
                    const worldPoint = getWorldPointFromEvent(event);
                    if (worldPoint) {
                      engine.setPendingInsertPoint(worldPoint);
                    }
                    toolbarDragRef.current = {
                      request,
                      startX: event.clientX,
                      startY: event.clientY,
                      moved: false,
                    };
                    setToolbarDragging(true);
                    engine.setToolbarDragging(true);
                    return;
                  }
                  if (item.opensPicker) {
                    handlePickImage();
                    return;
                  }
                  handleInsertRequest(request);
                }}
                disabled={isLocked}
                className="group h-8 w-8"
              >
                <Icon size={toolbarIconSize} className={toolbarIconClassName} />
              </IconBtn>
            );
          })}
        </div>
        <input
          ref={imageInputRef}
          type="file"
          accept="image/*"
          className="hidden"
          onChange={handleImageChange}
        />
      </div>
    </div>
  );
});

export default BoardToolbar;
