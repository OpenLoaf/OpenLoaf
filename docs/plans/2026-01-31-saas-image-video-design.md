# 图像/视频生成 SaaS 化改造：产品设计文档（草案）

日期：2026-01-31

## 一、总体目标与边界
将现有图像与视频生成从“模型直连”改为“服务端代理调用 SaaS”，统一走 `/ai/image` 与 `/ai/vedio` 两个 SaaS 接口。
前端负责输入、展示、发起运行与轮询；服务端负责转发、鉴权、资源落库与模型列表缓存。

范围内：SaaS 接入、任务轮询、资源保存、节点一致化体验。
范围外：自动模式、建议生成、模型智能选择等能力（不做）。

## 二、核心流程与职责划分
- 前端：
  - 收集提示词、图片、参数与模型选择
  - 点击运行后创建 LoadingNode
  - 发起轮询并展示结果
  - 未登录不可运行
- 服务端：
  - 代理转发 SaaS 请求（注入 token 与必要预处理）
  - 下载 SaaS 返回的图片/视频 URL，保存到画布资产目录
  - 返回项目内路径给前端
  - 缓存模型列表与能力资料
- SaaS：
  - 提供模型列表、生成接口与任务查询
  - 返回 taskId 与结果 URL

## 三、SDK 统一契约与双向适配层
SaaS 提供 SDK（类型与请求/响应标准），服务端以 SDK 类型作为唯一契约来源。
前端请求仍走 Server，但请求/响应结构遵循 SDK 类型。
服务端可在转发前后做预处理（参数补齐、鉴权注入、结果归一化）。

## 四、模型筛选机制（前端主导）
模型列表由服务端启动/定时拉取并缓存，前端读取后按能力规则过滤可用模型：
- 例如：输入 3 张图片仅保留支持多图的模型
- 遮罩、音频输出等必须由模型特性支持，不做代码补偿
该过滤逻辑在前端执行，服务端只提供模型列表与能力信息。

## 五、运行与任务轮询（前端驱动 + 服务端落库）
- 点击运行：前端创建 LoadingNode
- 发起任务：前端请求服务端，服务端转发到 SaaS
- 返回 taskId：前端开始轮询
- 获取结果：SaaS 返回 URL，服务端下载并保存到画布 assets 目录
- 前端用“项目内路径”替换 LoadingNode 成最终节点
- 未登录不可运行，失败与超时需明确错误态与重试入口

## 六、模型列表与参考资料缓存策略（服务端）
- 启动时拉取 + 每日定时刷新
- 失败降级：继续使用旧缓存
- 返回更新时间（用于调试与排查，不要求前端展示）
- 若 SaaS 支持版本/etag，可做条件刷新

## 七、节点交互与权限控制
- ImageGenerateNode 与 VideoGenerateNode 运行流程一致：点击运行即创建 LoadingNode
- 登录态控制运行权限
- 运行中参数不强制锁定，但建议避免“运行中修改”导致任务不一致

## 八、错误处理与可观测性
- 统一错误码与错误信息映射
- 失败阶段清晰区分：提交失败 / 轮询超时 / 下载失败 / 保存失败
- 服务端日志记录 taskId、projectId、nodeId，便于追踪
- 轮询支持最大次数与退避策略
