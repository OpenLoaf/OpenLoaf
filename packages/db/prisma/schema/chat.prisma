model ChatSession {
  id           String        @id
  title        String        @default("新对话") /// @zod.min(1)
  isUserRename Boolean       @default(false)
  isPin        Boolean       @default(false)
  errorMessage String? /// Error message for last failed request.
  sessionPreface String? /// Session preface text for chat history and model context.
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  workspaceId  String? /// Workspace id.
  projectId    String? /// Project id.
  boardId      String? /// Board id.
  cliId        String? /// CLI thread id formatted as {cliType}_{threadId}.
  deletedAt    DateTime? /// @zod.optional()
  messages     ChatMessage[]

  @@index([deletedAt])
  @@index([deletedAt, createdAt])
  @@index([isPin, updatedAt])
  @@unique([cliId])
}

model ChatMessage {
  id              String      @id
  sessionId       String
  // 消息树：父消息 ID（根节点为 null）
  parentMessageId String?
  // 物化路径：用于子树查询与“最右叶子”选择（格式：01/02/...；同级最多 99）
  path            String
  // 角色：与 AI SDK UIMessage.role 保持一致（小写）
  role            MessageRole @default(user)
  // Message kind for compaction handling.
  messageKind     MessageKind @default(normal)
  // UIMessage.parts 原始数组（只存可渲染/可回放的 parts）
  parts           Json
  // UIMessage.metadata（禁止保存消息树信息：id/sessionId/parentMessageId/path）
  metadata        Json? /// @zod.optional()
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  session         ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@index([sessionId, updatedAt])
  @@index([sessionId, parentMessageId, createdAt])
  @@index([sessionId, path])
  @@index([role])
}

enum MessageRole {
  user
  assistant
  system
  subagent
}

enum MessageKind {
  normal
  compact_prompt
  compact_summary
}
