model ChatSession {
  id           String        @id
  title        String        @default("新对话") /// @zod.min(1)
  agents       Json? /// @zod.optional()
  systemPrompt String? /// @zod.optional()
  contextId    String? /// @zod.optional()
  isUserRename Boolean       @default(false)
  isPin        Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  deletedAt    DateTime? /// @zod.optional()
  messages     ChatMessage[]

  // 对话会话关联的页面（多对多关系）
  pageChatSessions PageChatSession[]

  @@index([deletedAt])
  @@index([deletedAt, createdAt])
}

model ChatMessage {
  id                String            @id
  sessionId         String
  // 消息树：父消息 ID（根节点为 null）
  parentMessageId   String?
  // 节点层数（根为 0）
  depth             Int
  // sibling 序号（从 1 开始；每个 parentMessageId 维度独立递增）
  index             Int
  // 物化路径：用于子树查询与“最右叶子”选择（格式：00000001/00000002/...）
  path              String
  role              MessageRole       @default(USER)
  // 用户输入内容（仅 USER 角色使用；assistant/tool/system 为空）
  userText          String? /// @zod.optional()
  // 预留：上传/引用资源（MVP 暂不使用）
  resources         Json? /// @zod.optional()
  // 产出该消息的 agentId（仅 assistant/tool/system 可能使用；USER 为空）
  agentId           String? /// @zod.optional()
  meta              Json? /// @zod.optional()
  createdAt         DateTime          @default(now())
  session           ChatSession       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  parts             ChatMessagePart[]

  @@index([sessionId, createdAt])
  @@index([sessionId, depth, createdAt])
  @@index([sessionId, parentMessageId, createdAt])
  @@index([sessionId, parentMessageId, index])
  @@index([sessionId, path])
  @@index([agentId])
  @@index([role])
}

model ChatMessagePart {
  id        String      @id @default(cuid())
  messageId String
  index     Int
  // 统一把 UIMessage.parts 原始对象存进 state（包含 type/状态/工具输出等）
  state     Json
  createdAt DateTime    @default(now())
  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId, index])
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL
}

model SubAgentDefinition {
  id String @id

  // 所属工作区（仅保留ID，不做外键关联）
  workspaceId String

  // subAgent 名称（前端展示也用它）
  name String

  enabled Boolean @default(true)

  // 子 agent 的 system prompt（AI SDK v6: instructions）
  systemPrompt String

  // 模型参数（MVP 暂不强依赖；后续可按 provider/model 配置）
  model Json? /// @zod.optional()

  // 工具白名单（字符串数组），由代码内 ToolFactoryRegistry 解析
  toolKeys Json

  // 允许继续委派的 subAgent 名称数组（可选）
  allowedSubAgents Json? /// @zod.optional()

  // 最大嵌套深度（可选）
  maxDepth Int? /// @zod.optional()

  // 最大步数（用 stepCountIs(maxSteps) 转成 stopWhen）
  maxSteps Int? /// @zod.optional()

  // 绑定的 pageId 数组（可选；用于路由/启用范围）
  pageIds Json? /// @zod.optional()

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workspaceId, name])
  @@index([workspaceId, enabled])
  @@index([workspaceId, updatedAt])
}
