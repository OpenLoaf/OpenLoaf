model ChatSession {
  id           String        @id @default(cuid())
  title        String        @default("新对话") /// @zod.min(1)
  agents       Json? /// @zod.optional()
  systemPrompt String? /// @zod.optional()
  contextId    String? /// @zod.optional()
  isUserRename Boolean       @default(false)
  isPin        Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  deletedAt    DateTime? /// @zod.optional()
  messages     ChatMessage[]

  // 对话会话关联的页面（多对多关系）
  pageChatSessions PageChatSession[]

  @@index([deletedAt])
  @@index([deletedAt, createdAt])
}

model ChatMessage {
  id                String            @id @default(cuid())
  sessionId         String
  previousMessageId String?
  role              MessageRole       @default(USER)
  meta              Json? /// @zod.optional()
  createdAt         DateTime          @default(now())
  session           ChatSession       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  parts             ChatMessagePart[]

  @@index([sessionId, createdAt])
  @@index([previousMessageId])
  @@index([role])
}

model ChatMessagePart {
  id        String      @id @default(cuid())
  messageId String
  index     Int
  // 直接使用字符串保存UIMessage的类型
  type      String
  errorText String? /// @zod.optional()
  uiState   String? /// @zod.optional()
  state     Json? /// @zod.optional()
  createdAt DateTime    @default(now())
  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId, index])
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL
}
